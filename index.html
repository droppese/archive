<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë£Œ ë‚˜ëˆ” ê²Œì‹œíŒ (ë°ê³  ì‹¬í”Œí•œ í…Œë§ˆ)</title>
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa; 
            margin: 0;
            padding: 20px; 
            line-height: 1.6;
        }

        .container {
            max-width: 1000px; 
            margin: auto;
            background: #ffffff; 
            padding: 25px;
            border-radius: 12px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.1); 
            position: relative;
            min-height: 80vh; 
        }

        h1 {
            color: #34495e; 
            border-bottom: 3px solid #3498db; 
            padding-bottom: 10px;
            margin-bottom: 20px; /* ë§ˆì§„ ì¡°ì • */
            font-size: 1.8em; 
            font-weight: 600;
        }
        
        /* --- ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ --- */
        .search-box {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }

        #searchInput {
            width: 100%;
            padding: 10px 35px 10px 10px; 
            box-sizing: border-box; 
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6; 
            pointer-events: none; 
            font-size: 1.2em;
        }
        
        /* ì‚¬ìš©ì ì»¨íŠ¸ë¡¤ ì˜ì—­ (ìƒë‹¨) */
        #userControlArea {
            text-align: left;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: flex; 
            justify-content: space-between;
            flex-wrap: wrap; 
            align-items: center;
        }
        
        #userControlArea > div { margin-top: 5px; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #userControlArea button, footer button, .form-actions button { 
            background-color: #e9ecef; 
            color: #34495e;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 5px; 
            font-size: 0.9em; 
            transition: all 0.2s;
            white-space: nowrap;
        }

        #userControlArea button:hover, footer button:hover, .form-actions button:hover {
            background-color: #dee2e6;
        }
        
        #buyerLoginBtn, #viewHistoryBtn {
            background-color: #3498db; 
            color: white;
            font-weight: bold;
        }
        
        #buyerLoginBtn:hover, #viewHistoryBtn:hover {
            background-color: #2980b9;
        }

        .status-message.buyer { color: #3498db; font-weight: 600; }

        /* ë“±ë¡ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #registerButtonContainer {
            margin: 15px 0;
            text-align: right;
        }
        
        #registerButtonContainer button {
            background-color: #27ae60; 
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
        }
        
        #registerButtonContainer button:hover {
            background-color: #2ecc71;
        }

        /* --- ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ (ê³µí†µ ì¹´ë“œ êµ¬ì¡°) ìŠ¤íƒ€ì¼ --- */
        
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 15px; /* ì•„ì´í…œ ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
            margin-top: 15px;
        }
        
        #adminListPage .list-container {
             margin-top: 25px;
             border: 2px solid #e74c3c; 
             border-radius: 10px;
             padding: 15px;
             background-color: #fef5f4; 
        }

        /* ê°œë³„ ì•„ì´í…œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .item-card {
            display: flex; /* ì‚¬ì§„ê³¼ í…ìŠ¤íŠ¸ë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜ */
            align-items: flex-start; /* ìƒë‹¨ ì •ë ¬ */
            padding: 15px;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .item-card:hover {
            background-color: #f5f5f5;
        }

        /* ì¸ë„¤ì¼ Wrapper */
        .item-thumbnail-wrapper {
            min-width: 60px; /* ê³ ì • ë„ˆë¹„ */
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            margin-right: 15px;
            border: 1px solid #bdc3c7;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ecf0f1;
            font-size: 0.7em;
            color: #7f8c8d;
        }
        
        .item-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            border-radius: 8px;
            border: none; 
        }

        /* í…ìŠ¤íŠ¸ ì»¨í…ì¸  ì˜ì—­ */
        .item-content {
            flex-grow: 1;
            min-width: 0;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        
        /* ê´€ë¦¬ì ëª©ë¡: ì´ë¦„ê³¼ ìƒíƒœë¥¼ ì„¸ë¡œë¡œ ë°°ì¹˜í•˜ê¸° ìœ„í•œ ì¡°ì • */
        .admin-card .item-header {
            display: block; 
            margin-bottom: 0;
        }
        .admin-card .item-name {
            display: block; 
            margin-right: 0;
            margin-bottom: 5px; 
            white-space: normal; 
            overflow: visible; 
            text-overflow: clip;
        }
        .admin-card .item-status {
             display: block; 
             margin-bottom: 5px;
        }


        .item-name {
            font-weight: 700;
            color: #34495e;
            font-size: 1.1em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; 
            margin-right: 10px;
        }

        /* ì•„ì´í…œ ìƒíƒœ ë° ê¸°íƒ€ ì •ë³´ */
        .item-info {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .item-actions {
            margin-top: 8px;
            /* ê´€ë¦¬ì ë²„íŠ¼ ì •ë ¬ ê°œì„  */
            display: flex;
            flex-wrap: wrap; 
            gap: 5px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }

        /* ë””í…Œì¼ ë‚´ìš© (DIV í˜•íƒœë¡œ ë³€ê²½ë¨) */
        .detail-row {
            display: none;
            width: 100%;
            background-color: #ecf0f1; 
            padding: 15px;
            border-radius: 8px;
            margin-top: -10px; 
            border: 1px dashed #ccc;
            border-top: none; 
            box-sizing: border-box;
        }

        /* ì•„ì´í…œ ìƒíƒœë³„ ìƒ‰ìƒ */
        .status-waiting { color: #f39c12; font-weight: bold; } 
        .status-selling { color: #27ae60; font-weight: bold; } 
        .status-reserved { color: #8e44ad; font-weight: bold; } 
        .status-completed { color: #95a5a6; } 
        .status-cancelled { color: #e74c3c; font-weight: bold; } /* ì·¨ì†Œ ìƒíƒœ ì¶”ê°€ */
        
        /* --- ìƒì„¸ ì´ë¯¸ì§€ ì˜ì—­ ìŠ¤íƒ€ì¼ ì¡°ì • --- */
        .detail-image-box {
            text-align: center;
            margin: 10px auto 15px auto;
            max-width: 100%; 
            height: auto;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #ecf0f1;
            display: block;
            padding: 0;
            overflow: hidden;
        }

        /* ì´ë¯¸ì§€ ìì²´ì— ì ìš©í•˜ì—¬ ìµœëŒ€ ë„ˆë¹„ ë³´ì¥ */
        .detail-image-box img {
            max-width: 100%; 
            height: auto; 
            display: block;
        }
        
        .detail-image-box.no-image {
            width: 100%;
            max-width: 250px;
            height: 150px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            color: #7f8c8d;
            font-weight: bold;
        }

        /* ì•¡ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .admin-action-btn, .action-btn {
            padding: 8px 12px;
            margin: 0; 
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .trade-apply-btn { background-color: #3498db; color: white; } 
        .approve-btn { background-color: #2ecc71; color: white; } 
        .approve-trade-btn { background-color: #1abc9c; color: white; } 
        .confirm-trade-btn { background-color: #9b59b6; color: white; } 
        .cancel-trade-btn { background-color: #e74c3c; color: white; } 
        .edit-btn { background-color: #f1c40f; color: #333; } 
        .delete-btn { background-color: #bdc3c7; color: #333; }
        
        .cancel-btn { 
            background-color: #bdc3c7; 
            color: #333;
        }
        
        .cancel-btn:hover { background-color: #95a5a6; }

        .detail-content {
            padding: 15px;
            font-size: 0.9em; 
            color: #555;
        }
        
        /* ê´€ë¦¬ì ëª©ë¡ê³¼ êµ¬ë§¤ì ë‚´ì—­ ì „ìš© ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .admin-card {
            background-color: #fff8f8; /* ê´€ë¦¬ì ëª©ë¡ ë°°ê²½ìƒ‰ */
        }
        .history-card {
            background-color: #f9fcff; /* êµ¬ë§¤ì ë‚´ì—­ ë°°ê²½ìƒ‰ */
            cursor: default; 
        }
        .history-card:hover {
            background-color: #f9fcff;
        }
        
        .admin-info {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* í‘¸í„° ìŠ¤íƒ€ì¼ */
        footer {
            max-width: 1000px;
            margin: 30px auto 0 auto;
            padding: 15px 25px;
            text-align: center;
            border-top: 1px solid #ecf0f1;
            background-color: #3498db; 
            color: white;
            border-radius: 12px;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
        }
        
        footer #adminLoginBtn {
            background-color: #e74c3c; 
            color: white;
            padding: 10px 18px;
            font-weight: bold;
        }
        
        footer #adminLoginBtn:hover {
            background-color: #c0392b;
        }
        
        /* ì•„ì´í…œ ë“±ë¡ í¼ ìŠ¤íƒ€ì¼ */
        #registrationFormPage {
            padding: 20px;
            border: 1px solid #3498db;
            border-radius: 10px;
            background-color: #f9fcff;
        }

        #registrationFormPage h3 {
            color: #34495e;
            border-bottom: 2px solid #bdc3c7;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        /* í¼ ìš”ì†Œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        #itemName, #itemImageFile, #itemDescription {
            width: 100%;
            padding: 10px;
            box-sizing: border-box; 
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        
        #itemImageFile {
            border: none;
            padding: 10px 0;
        }

        #itemDescription {
            height: 120px; 
            resize: vertical;
        }

        .form-actions {
            margin-top: 20px;
        }
        
        /* --- ëª¨ë°”ì¼ ìµœì í™” (ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜) --- */
        @media (max-width: 600px) {
            
            body { padding: 10px 5px; }
            .container { padding: 15px; }

            /* ì•„ì´í…œ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ìµœì í™” */
            .item-card {
                flex-direction: row; 
                align-items: center; 
            }

            .item-thumbnail-wrapper {
                min-width: 60px; 
                height: 60px;
                margin-right: 10px;
            }
            
            .item-content {
                display: flex;
                flex-direction: column;
                flex-grow: 1;
            }
            
            .item-header {
                flex-wrap: nowrap; 
                margin-bottom: 3px;
            }

            .item-name {
                flex-grow: 1; 
                font-size: 1em;
                white-space: normal; 
            }
            
            .item-status {
                font-size: 0.85em;
                margin-left: 10px;
            }
            
            .admin-card .item-status {
                margin-left: 0; 
            }

            .item-info {
                font-size: 0.75em;
                margin-bottom: 5px;
                white-space: nowrap; 
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .item-actions {
                margin-top: 0;
                text-align: left; 
            }
            
            .action-btn {
                padding: 6px 8px;
                font-size: 0.75em;
                display: inline-block; 
                margin: 0 4px 0 0;
            }
            
            /* ë””í…Œì¼ ë‚´ìš©ì˜ ë§ˆì§„ ì¡°ì • */
            .detail-row {
                margin-top: -15px; 
            }
            
            .admin-info {
                font-size: 0.7em;
            }
            
            footer button {
                padding: 6px 10px;
                font-size: 0.75em;
            }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div id="userControlArea">
            <div>
                <button id="viewHistoryBtn" onclick="toggleBuyerHistoryPage(true)" style="display: none;">ë‚´ ì‹ ì²­ ë‚´ì—­ ë³´ê¸°</button>
                <button id="buyerLoginBtn" onclick="toggleBuyerLogin()">êµ¬ë§¤ì ë¡œê·¸ì¸</button>
            </div>
            <p id="buyerStatus" class="status-message buyer" style="display: none;">**êµ¬ë§¤ì: <span id="currentBuyerName"></span> í™œì„±í™”**</p>
        </div>

        <h1>ğŸ ë¬´ë£Œ ë‚˜ëˆ” ê²Œì‹œíŒ</h1>
        
        <div id="mainContent">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ì•„ì´í…œ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
                    <span class="search-icon">ğŸ”</span>
                </div>
            </div>
            
            <div id="registerButtonContainer">
                <button onclick="toggleRegistrationForm(true)">ğŸ“¦ ì•„ì´í…œ ë“±ë¡í•˜ê¸°</button>
            </div>
            
            <div id="item-list-container" class="list-container">
                </div>
            
        </div>
        
        <div id="adminListPage" style="display: none;">
            <h2>ğŸš¨ ê´€ë¦¬ ëŒ€ê¸° ëª©ë¡ (ë“±ë¡ ìŠ¹ì¸ ë° ê±°ë˜ ê´€ë¦¬)</h2>
            <p>ì‹ ê·œ ë“±ë¡ ìŠ¹ì¸, ë‚˜ëˆ” ì‹ ì²­ ìŠ¹ì¸, ê±°ë˜ í™•ì • ê´€ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>
            
            <button class="cancel-btn" onclick="toggleAdminListPage(false)" style="width: auto; margin-bottom: 20px;">ë©”ì¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

            <div id="adminListContainer" class="list-container">
                </div>
        </div>

        <div id="registrationFormPage" style="display: none;">
            <h3>ì•„ì´í…œ ë“±ë¡ ìš”ì²­</h3>
            <div class="form-content">
                
                <input type="text" id="itemName" placeholder="ì•„ì´í…œ ì´ë¦„">
                
                <label for="itemImageFile" style="font-size: 0.9em; display: block; margin-top: 10px;">ì•„ì´í…œ ì‚¬ì§„ íŒŒì¼ ì„ íƒ:</label>
                <input type="file" id="itemImageFile" accept="image/*">
                
                <textarea id="itemDescription" placeholder="ìƒì„¸ ì„¤ëª… ë° ë‚˜ëˆ” ì¡°ê±´ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                
                <div class="form-actions">
                    <button onclick="addItemAsync()">ë“±ë¡ ìš”ì²­í•˜ê¸°</button>
                    <button class="cancel-btn" onclick="toggleRegistrationForm(false)">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <div id="buyerHistoryPage" style="display: none;">
            <h2>ğŸ‘¤ <span id="historyBuyerName"></span> ë‹˜ì˜ ì‹ ì²­ ë‚´ì—­</h2>
            <p>ë‚˜ëˆ” ì‹ ì²­ ë° ì™„ë£Œ ì´ë ¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            
            <button class="cancel-btn" onclick="toggleBuyerHistoryPage(false)" style="width: auto; margin-bottom: 20px;">ë©”ì¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

            <div id="historyListContainer" class="list-container">
                </div>
        </div>
    </div>
    
    <footer>
        <button id="adminListBtn" onclick="toggleAdminListPage(true)" style="display: none; background-color: #dc3545; color: white; margin-right: 15px;">ğŸš¨ ê´€ë¦¬ ëŒ€ê¸° ëª©ë¡ ë³´ê¸°</button>
        <button id="adminLoginBtn" onclick="toggleAdminLogin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
    </footer>

    <script>
        let isAdmin = false;
        let isBuyerLoggedIn = false;
        let currentBuyerId = null;

        const buyers = {
            'buyer1': '1111',
            'buyer2': '2222'
        };
        
        const NO_IMAGE_TEXT = 'ì´ë¯¸ì§€ ì—†ìŒ';
        const NO_IMAGE_PLACEHOLDER = 'https://via.placeholder.com/150/808080/FFFFFF?text=No+Image';
        const THUMBNAIL_PLACEHOLDER = 'https://via.placeholder.com/60/808080/FFFFFF?text=No+Img'; 
        
        function isValidImageUrl(url) {
            return url && url.trim() !== '' && url.indexOf('No+Image') === -1 && url.indexOf('No+Img') === -1;
        }

        // --- ì•„ì´í…œ ë°ì´í„° (ì¹´í…Œê³ ë¦¬ ì •ë³´ëŠ” ë°ì´í„° êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ 'ê¸°íƒ€'ë¡œ í†µì¼) ---
        const items = [
            { id: 1, name: 'ê°•í™”ëœ ê²€', status: 'íŒë§¤ ì¤‘', description: 'ê³µê²©ë ¥ì´ 10 ì¦ê°€í•˜ëŠ” í¬ê·€í•œ ê²€ì…ë‹ˆë‹¤. ë‚´êµ¬ë„ 90%.', imageUrl: 'https://via.placeholder.com/150/007BFF/FFFFFF?text=Sword', buyerId: null, registerDate: '2025-11-10', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 2, name: 'ë§ˆë²•ì‚¬ ëª¨ì', status: 'ê±°ë˜ ì™„ë£Œ', description: 'ì§€ëŠ¥ì„ ì˜¬ë ¤ì£¼ëŠ” ì¼ë°˜ì ì¸ ëª¨ìì…ë‹ˆë‹¤.', imageUrl: '', buyerId: 'buyer2', registerDate: '2025-11-11', historyStatus: 'ê±°ë˜ í™•ì •', historyBuyerId: 'buyer2', category: 'ê¸°íƒ€' },
            { id: 3, name: 'ë¹›ë‚˜ëŠ” ë°©íŒ¨', status: 'ì˜ˆì•½ì¤‘', description: 'í¬ë¯¸í•œ ë¹›ì„ ë‚´ëŠ” íŠ¼íŠ¼í•œ ë°©íŒ¨ì…ë‹ˆë‹¤. ë°©ì–´ë ¥ 5 ì¦ê°€.', imageUrl: 'https://via.placeholder.com/150/FFC107/333333?text=Shield', buyerId: 'buyer1', registerDate: '2025-11-12', historyStatus: 'ì˜ˆì•½ ìŠ¹ì¸', historyBuyerId: 'buyer1', category: 'ê¸°íƒ€' },
            { id: 4, name: 'ê³ ëŒ€ ì§€ë„ ì¡°ê°', status: 'ìŠ¹ì¸ ëŒ€ê¸°', description: 'ë§¤ìš° í¬ê·€í•´ ë³´ì´ëŠ” ë³´ì„ì…ë‹ˆë‹¤.', imageUrl: null, buyerId: null, registerDate: '2025-11-13', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 5, name: 'ì‹ ì†ì˜ í¬ì…˜', status: 'ì˜ˆì•½ì¤‘', description: 'ê±°ë˜ ì‹ ì²­ì´ ë“¤ì–´ì˜¨ í¬ì…˜ì…ë‹ˆë‹¤. 1íšŒìš©.', imageUrl: 'https://via.placeholder.com/150/DC3545/FFFFFF?text=Potion', buyerId: 'buyer1', registerDate: '2025-11-13', historyStatus: 'ì‹ ì²­ ì¤‘', historyBuyerId: 'buyer1', category: 'ê¸°íƒ€' },
            { id: 6, name: 'ë‚¡ì€ ê°€ì£½ ê°‘ì˜·', status: 'íŒë§¤ ì¤‘', description: 'ê¸°ë³¸ ë°©ì–´ë ¥ì´ ìˆëŠ” ë‚¡ì€ ê°‘ì˜·.', imageUrl: 'https://via.placeholder.com/150/8B4513/FFFFFF?text=Armor', buyerId: null, registerDate: '2025-11-14', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 7, name: 'íˆ¬ëª… ë§í† ', status: 'ìŠ¹ì¸ ëŒ€ê¸°', description: 'ìˆ¨ê²¨ì§„ ì•„ì´í…œ. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘.', imageUrl: '   ', buyerId: null, registerDate: '2025-11-15', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 8, name: 'ìƒëª…ì˜ ë°˜ì§€', status: 'íŒë§¤ ì¤‘', description: 'ì²´ë ¥ ì¬ìƒ ì†ë„ë¥¼ ë†’ì—¬ì£¼ëŠ” ë°˜ì§€.', imageUrl: 'https://via.placeholder.com/150/FF69B4/FFFFFF?text=Ring', buyerId: null, registerDate: '2025-11-16', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 9, name: 'ë¶ˆì˜ ì •ìˆ˜', status: 'ì˜ˆì•½ì¤‘', description: 'ë¶ˆ ë§ˆë²• ì¬ë£Œ.', imageUrl: 'https://via.placeholder.com/150/FF4500/FFFFFF?text=Essence', buyerId: 'buyer2', registerDate: '2025-11-17', historyStatus: 'ì‹ ì²­ ì¤‘', historyBuyerId: 'buyer2', category: 'ê¸°íƒ€' },
            { id: 10, name: 'ë§ˆë‚˜ ë¬¼ì•½(ëŒ€)', status: 'ì˜ˆì•½ì¤‘', description: 'ëŒ€ëŸ‰ì˜ ë§ˆë‚˜ë¥¼ íšŒë³µì‹œì¼œì£¼ëŠ” ë¬¼ì•½.', imageUrl: 'https://via.placeholder.com/150/00FFFF/000000?text=MP+Pot', buyerId: 'buyer2', registerDate: '2025-11-18', historyStatus: 'ì˜ˆì•½ ìŠ¹ì¸', historyBuyerId: 'buyer2', category: 'ê¸°íƒ€' },
            { id: 11, name: 'ë¯¸ë‹ˆ ê³¨ë ˜ ì¡°ê°', status: 'ê±°ë˜ ì™„ë£Œ', description: 'ì‘ì€ ê³¨ë ˜ì„ ì†Œí™˜í•˜ëŠ” ë° ì‚¬ìš©ëœ ì¡°ê°.', imageUrl: 'https://via.placeholder.com/150/A9A9A9/000000?text=Golem', buyerId: 'buyer1', registerDate: '2025-11-19', historyStatus: 'ê±°ë˜ í™•ì •', historyBuyerId: 'buyer1', category: 'ê¸°íƒ€' },
            { id: 12, name: 'ë²ˆê°œ ì§€íŒ¡ì´', status: 'íŒë§¤ ì¤‘', description: 'ë²ˆê°œ ë§ˆë²• ì¦í­.', imageUrl: 'https://via.placeholder.com/150/800080/FFFFFF?text=Wand', buyerId: null, registerDate: '2025-11-20', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 13, name: 'ìš©ì˜ ë¹„ëŠ˜', status: 'íŒë§¤ ì¤‘', description: 'í¬ê·€ ë°©ì–´êµ¬ ì œì‘ ì¬ë£Œ.', imageUrl: 'https://via.placeholder.com/150/4682B4/FFFFFF?text=Scale', buyerId: null, registerDate: '2025-11-21', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 14, name: 'ì‚¬ëƒ¥ê¾¼ì˜ í™œ', status: 'ì˜ˆì•½ì¤‘', description: 'ì •í™•ë„ê°€ ë†’ì€ í™œ.', imageUrl: 'https://via.placeholder.com/150/228B22/FFFFFF?text=Bow', buyerId: 'buyer1', registerDate: '2025-11-22', historyStatus: 'ì‹ ì²­ ì¤‘', historyBuyerId: 'buyer1', category: 'ê¸°íƒ€' },
            { id: 15, name: 'ë… ì¶”ì¶œì•¡', status: 'íŒë§¤ ì¤‘', description: 'ë¬´ê¸°ì— ë…ì„ ë°”ë¥´ëŠ” ë° ì‚¬ìš©.', imageUrl: 'https://via.placeholder.com/150/556B2F/FFFFFF?text=Poison', buyerId: null, registerDate: '2025-11-23', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 16, name: 'ë¯¸ìŠ¤í„°ë¦¬ ìƒì', status: 'íŒë§¤ ì¤‘', description: 'ë¬´ì—‡ì´ ë“¤ì–´ìˆì„ì§€ ì•„ë¬´ë„ ëª¨ë¥´ëŠ” ìƒì.', imageUrl: 'https://via.placeholder.com/150/9932CC/FFFFFF?text=Box', buyerId: null, registerDate: '2025-11-24', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 17, name: 'ì˜ì›ì˜ ì´›ë¶ˆ', status: 'ìŠ¹ì¸ ëŒ€ê¸°', description: 'ì ˆëŒ€ êº¼ì§€ì§€ ì•ŠëŠ” ì‹ ë¹„í•œ ì´›ë¶ˆ.', imageUrl: 'https://via.placeholder.com/150/FFD700/000000?text=Candle', buyerId: null, registerDate: '2025-11-25', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 18, name: 'ì‹œê°„ì˜ ëª¨ë˜', status: 'íŒë§¤ ì¤‘', description: 'ì‹œê°„ì„ ë˜ëŒë¦¬ëŠ” ë° í•„ìš”í•œ ë§ˆë²• ì¬ë£Œ.', imageUrl: 'https://via.placeholder.com/150/B0C4DE/000000?text=Sand', buyerId: null, registerDate: '2025-11-26', historyStatus: 'ì‹ ì²­ ì—†ìŒ', category: 'ê¸°íƒ€' },
            { id: 19, name: 'ìŒìœ ì‹œì¸ì˜ ë¦¬ë¼', status: 'ê±°ë˜ ì™„ë£Œ', description: 'ì•„ë¦„ë‹¤ìš´ ìŒì•…ì„ ì—°ì£¼í•˜ëŠ” ì•…ê¸°.', imageUrl: 'https://via.placeholder.com/150/CD853F/FFFFFF?text=Lyre', buyerId: 'buyer2', registerDate: '2025-11-27', historyStatus: 'ê±°ë˜ í™•ì •', historyBuyerId: 'buyer2', category: 'ê¸°íƒ€' },
            { id: 20, name: 'ë‹¬ë¹› ìˆ˜ì •êµ¬', status: 'ì˜ˆì•½ì¤‘', description: 'ë°¤ì—ë„ ì£¼ë³€ì„ ë°ê²Œ ë¹„ì¶°ì£¼ëŠ” ìˆ˜ì •êµ¬.', imageUrl: 'https://via.placeholder.com/150/DDA0DD/000000?text=Crystal', buyerId: 'buyer1', registerDate: '2025-11-28', historyStatus: 'ì˜ˆì•½ ìŠ¹ì¸', historyBuyerId: 'buyer1', category: 'ê¸°íƒ€' }
        ];

        // --- ë Œë”ë§ í•¨ìˆ˜ ---

        function getTodayDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getStatusClass(status) {
            if (status === 'ìŠ¹ì¸ ëŒ€ê¸°') return 'status-waiting';
            if (status === 'íŒë§¤ ì¤‘') return 'status-selling'; 
            if (status === 'ì˜ˆì•½ì¤‘') return 'status-reserved'; 
            if (status === 'ê±°ë˜ ì™„ë£Œ') return 'status-completed'; 
            if (status === 'ì·¨ì†Œë¨') return 'status-cancelled';
            return '';
        }
        
        function getDisplayStatusText(internalStatus, isBuyerMatch, historyStatus) {
            if (internalStatus === 'ìŠ¹ì¸ ëŒ€ê¸°') return 'ìŠ¹ì¸ ëŒ€ê¸°';
            if (internalStatus === 'íŒë§¤ ì¤‘') return 'ì‹ ì²­ ê°€ëŠ¥'; 
            if (internalStatus === 'ê±°ë˜ ì™„ë£Œ') {
                return isBuyerMatch ? 'ë‚˜ëˆ” ì™„ë£Œ! (íšë“)' : 'ë‚˜ëˆ” ì™„ë£Œ'; 
            }
            
            if (internalStatus === 'ì˜ˆì•½ì¤‘') {
                if (historyStatus === 'ì˜ˆì•½ ìŠ¹ì¸' && isBuyerMatch) {
                     return 'ì˜ˆì•½ ì¤‘(ë‚˜)'; 
                } else if (historyStatus === 'ì‹ ì²­ ì¤‘' && isBuyerMatch) {
                    return 'ì˜ˆì•½ ì¤‘(ì‹ ì²­)'; 
                } else if (historyStatus === 'ì˜ˆì•½ ìŠ¹ì¸' && !isBuyerMatch) {
                    return 'ì˜ˆì•½ ì¤‘'; 
                } else {
                    return 'ì˜ˆì•½ ì¤‘'; 
                }
            }
            
            return internalStatus;
        }

        
        function toggleBuyerHistoryPage(show) {
            const mainContent = document.getElementById('mainContent');
            const historyPage = document.getElementById('buyerHistoryPage');
            const registrationFormPage = document.getElementById('registrationFormPage');
            const adminPage = document.getElementById('adminListPage');

            if (show) {
                if (!isBuyerLoggedIn) {
                    alert('êµ¬ë§¤ìë¡œ ë¡œê·¸ì¸í•´ì•¼ ì‹ ì²­ ë‚´ì—­ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                mainContent.style.display = 'none';
                registrationFormPage.style.display = 'none';
                adminPage.style.display = 'none';
                historyPage.style.display = 'block';
                document.getElementById('historyBuyerName').textContent = currentBuyerId;
                renderBuyerHistory();
            } else {
                mainContent.style.display = 'block';
                historyPage.style.display = 'none';
                renderItems(items.filter(item => item.status !== 'ìŠ¹ì¸ ëŒ€ê¸°')); 
            }
        }
        
        function toggleRegistrationForm(show) {
            const mainContent = document.getElementById('mainContent');
            const formPage = document.getElementById('registrationFormPage');
            const historyPage = document.getElementById('buyerHistoryPage');
            const adminPage = document.getElementById('adminListPage');

            if (show) {
                mainContent.style.display = 'none';
                historyPage.style.display = 'none';
                adminPage.style.display = 'none';
                formPage.style.display = 'block';
                
                // í¼ ìš”ì†Œ ì´ˆê¸°í™”
                document.getElementById('itemName').value = '';
                document.getElementById('itemImageFile').value = '';
                document.getElementById('itemDescription').value = '';
                
            } else {
                mainContent.style.display = 'block';
                formPage.style.display = 'none';
                renderItems(items.filter(item => item.status !== 'ìŠ¹ì¸ ëŒ€ê¸°')); 
            }
        }
        
        function toggleAdminListPage(show) {
            const mainContent = document.getElementById('mainContent');
            const historyPage = document.getElementById('buyerHistoryPage');
            const formPage = document.getElementById('registrationFormPage');
            const adminPage = document.getElementById('adminListPage');

            if (show) {
                if (!isAdmin) {
                    alert('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì•¼ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                mainContent.style.display = 'none';
                historyPage.style.display = 'none';
                formPage.style.display = 'none';
                adminPage.style.display = 'block';
                renderAdminList(); 
            } else {
                mainContent.style.display = 'block';
                adminPage.style.display = 'none';
                renderItems(items.filter(item => item.status !== 'ìŠ¹ì¸ ëŒ€ê¸°')); 
            }
        }
        
        // --- í•µì‹¬: ë©”ì¸ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜ ---
        function renderItems(displayItems) {
            const listContainer = document.getElementById('item-list-container');
            listContainer.innerHTML = ''; 
            
            const statusOrder = { 'íŒë§¤ ì¤‘': 1, 'ì˜ˆì•½ì¤‘': 2, 'ê±°ë˜ ì™„ë£Œ': 3 };
            
            // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ì€ ë©”ì¸ì—ì„œ ì œì™¸ (í˜¸ì¶œí•˜ëŠ” ê³³ì—ì„œ ì´ë¯¸ í•„í„°ë§)
            displayItems.sort((a, b) => {
                const orderA = statusOrder[a.status] || 99;
                const orderB = statusOrder[b.status] || 99;
                return orderA - orderB;
            });

            if (displayItems.length === 0) {
                 listContainer.innerHTML = '<p style="text-align: center; color: #777; padding: 20px; margin: 0;">í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                 return;
            }

            displayItems.forEach(item => {
                
                const isNoImage = !isValidImageUrl(item.imageUrl);
                const displayImageUrl = isNoImage ? THUMBNAIL_PLACEHOLDER : item.imageUrl;
                
                let thumbnailHtml = '';
                if (isNoImage) {
                    thumbnailHtml = `<div class="item-thumbnail-wrapper">${NO_IMAGE_TEXT}</div>`;
                } else {
                    thumbnailHtml = `<div class="item-thumbnail-wrapper"><img src="${displayImageUrl}" alt="${item.name} ì´ë¯¸ì§€" class="item-thumbnail"></div>`;
                }

                const isBuyerMatch = isBuyerLoggedIn && item.buyerId === currentBuyerId;

                let statusText = getDisplayStatusText(item.status, isBuyerMatch, item.historyStatus); 
                let statusClass = getStatusClass(item.status);
                
                let actionButton = '';
                if (isAdmin) {
                    // ë©”ì¸ ëª©ë¡ì—ì„œëŠ” ê´€ë¦¬ìë„ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
                    actionButton = `
                        <button class="admin-action-btn edit-btn" onclick="editItem(${item.id})">ìˆ˜ì •</button>
                        <button class="admin-action-btn delete-btn item-delete-btn" data-item-id="${item.id}">ì‚­ì œ</button>
                    `;
                } else if (isBuyerLoggedIn && item.status === 'íŒë§¤ ì¤‘') { 
                    actionButton = `<button class="action-btn trade-apply-btn" onclick="applyForTrade(${item.id})">ì‹ ì²­</button>`;
                } else if (isBuyerLoggedIn && item.status === 'ì˜ˆì•½ì¤‘' && isBuyerMatch) {
                    // ë©”ì¸ ë¦¬ìŠ¤íŠ¸ì—ì„œë„ 'ì˜ˆì•½ ì·¨ì†Œ'ë¡œ í†µì¼ (ê¸°ì¡´ 'ì˜ˆì•½ ì·¨ì†Œ'ëŠ” 'ì‹ ì²­ ì·¨ì†Œ'ê°€ ë³€ê²½ëœ ê²ƒì„)
                    actionButton = `<button class="action-btn cancel-trade-btn" onclick="cancelTradeByBuyer(${item.id})">ì˜ˆì•½ ì·¨ì†Œ</button>`;
                } else if (!isBuyerLoggedIn && item.status === 'íŒë§¤ ì¤‘') {
                    actionButton = `<span style="color:#17a2b8;">ë¡œê·¸ì¸ í›„ ì‹ ì²­</span>`;
                } else if (item.status === 'ì˜ˆì•½ì¤‘' && item.buyerId !== currentBuyerId) {
                    actionButton = `<span class="${getStatusClass(item.status)}">${statusText}</span>`; 
                }

                
                // ìƒˆë¡œìš´ ì¹´ë“œ êµ¬ì¡° (DIV)
                const card = document.createElement('div');
                card.classList.add('item-card');
                card.setAttribute('data-id', item.id);
                
                card.innerHTML = `
                    ${thumbnailHtml}
                    <div class="item-content">
                        <div class="item-header">
                            <span class="item-name" title="${item.name}">${item.name}</span>
                            <span class="item-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="item-info">ë“±ë¡ì¼: ${item.registerDate || '-'}</div>
                        <div class="item-actions">
                            ${actionButton}
                        </div>
                    </div>
                `;
                
                // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                card.onclick = (event) => toggleDetails(item.id, event);
                listContainer.appendChild(card);
                
                // ê´€ë¦¬ì ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¬ì—°ê²°
                if (isAdmin) {
                    const deleteButton = card.querySelector(`.item-delete-btn[data-item-id="${item.id}"]`);
                    if (deleteButton) {
                        deleteButton.addEventListener('click', (event) => {
                            event.stopPropagation();
                            deleteItem(item.id);
                        });
                    }
                }

                // ë””í…Œì¼ DIV 
                const detailDiv = document.createElement('div');
                detailDiv.classList.add('detail-row');
                detailDiv.id = `detail-${item.id}`;
                
                const formattedDescription = (item.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.').replace(/\n/g, '<br>');
                const isDetailNoImage = !isValidImageUrl(item.imageUrl);
                const detailImageUrl = isDetailNoImage ? NO_IMAGE_PLACEHOLDER : item.imageUrl;
                
                let detailImageHtml = '';
                if (isDetailNoImage) {
                    detailImageHtml = `<div class="detail-image-box no-image">${NO_IMAGE_TEXT}</div>`;
                } else {
                    // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì •ì„ ìœ„í•´ img íƒœê·¸ë¥¼ detail-image-box ë‚´ì— ì‚½ì…
                    detailImageHtml = `<div class="detail-image-box"><img src="${detailImageUrl}" alt="${item.name} ìƒì„¸ ì´ë¯¸ì§€" class="detail-image"></div>`;
                }


                detailDiv.innerHTML = `
                    <div class="detail-content">
                        ${detailImageHtml}
                        <div class="detail-text">
                            <strong>ìƒì„¸ ì„¤ëª…:</strong><br>
                            ${formattedDescription}
                        </div>
                    </div>
                `;
                listContainer.appendChild(detailDiv);
            });
            
            
            const adminListBtn = document.getElementById('adminListBtn');
            const adminPageVisible = document.getElementById('adminListPage').style.display !== 'none';

            if (isAdmin && !adminPageVisible) {
                const adminCount = items.filter(item => item.status === 'ìŠ¹ì¸ ëŒ€ê¸°' || item.status === 'ì˜ˆì•½ì¤‘').length;
                adminListBtn.style.display = 'inline-block';
                adminListBtn.textContent = `ğŸš¨ ê´€ë¦¬ ëŒ€ê¸° ëª©ë¡ ë³´ê¸° (${adminCount}ê±´)`;
            } else {
                adminListBtn.style.display = 'none';
            }
        }

        // ì´ˆê¸°í™” í•¨ìˆ˜ ìˆ˜ì • (ì¹´í…Œê³ ë¦¬ í•„í„°ë§ ì œê±°)
        window.onload = function() {
            renderItems(items.filter(item => item.status !== 'ìŠ¹ì¸ ëŒ€ê¸°')); 
        };
        
        // --- toggleDetails í•¨ìˆ˜ ìˆ˜ì • (DIVì— ë§ê²Œ) ---
        function toggleDetails(itemId, event) {
            const detailDiv = document.getElementById(`detail-${itemId}`);
            
            // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ (ë²„íŠ¼ í´ë¦­ ì‹œ ë””í…Œì¼ ë‹«í˜ ë°©ì§€)
            const isTargetButton = event.target.closest('.item-actions') !== null || event.target.closest('.admin-action-btn') !== null;
            if (isTargetButton) return;
            
            if (detailDiv.style.display === 'block') { 
                detailDiv.style.display = 'none';
            } else {
                document.querySelectorAll('.detail-row').forEach(div => {
                    if (div.id !== `detail-${itemId}`) {
                        div.style.display = 'none';
                    }
                });
                detailDiv.style.display = 'block'; 
            }
        }
        
        // --- ìˆ˜ì •: êµ¬ë§¤ì ë‚´ì—­ ë Œë”ë§ í•¨ìˆ˜ (ì¹´ë“œ ë¦¬ìŠ¤íŠ¸) ---
        function renderBuyerHistory() {
            const listContainer = document.getElementById('historyListContainer');
            listContainer.innerHTML = '';

            const historyItems = items.filter(item => item.historyBuyerId === currentBuyerId);

            if (historyItems.length === 0) {
                 listContainer.innerHTML = '<p style="text-align: center; color: #777; padding: 20px; margin: 0;">ì•„ì§ ë‚˜ëˆ” ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                 return;
            }

            historyItems.forEach(item => {
                let displayStatus = '';
                let statusClass = '';
                let actionButton = ''; 

                if (item.historyStatus === 'ê±°ë˜ í™•ì •' && item.status === 'ê±°ë˜ ì™„ë£Œ') {
                    displayStatus = 'ê±°ë˜ í™•ì • (ë‚˜ëˆ” ì™„ë£Œ)';
                    statusClass = getStatusClass('ê±°ë˜ ì™„ë£Œ');
                } else if (item.historyStatus === 'ì˜ˆì•½ ìŠ¹ì¸' && item.status === 'ì˜ˆì•½ì¤‘') {
                    // ìƒíƒœëŠ” 'ì˜ˆì•½ ì™„ë£Œ(ìˆ˜ë ¹ê°€ëŠ¥)'
                    displayStatus = 'ì˜ˆì•½ ì™„ë£Œ(ìˆ˜ë ¹ê°€ëŠ¥)';
                    statusClass = getStatusClass('ì˜ˆì•½ì¤‘');
                    // ì•¡ì…˜ ë²„íŠ¼ ìˆ˜ì •: 'ì˜ˆì•½ ì·¨ì†Œ' -> 'ìˆ˜ë ¹ ì·¨ì†Œ'
                    actionButton = `<button class="action-btn cancel-trade-btn" onclick="cancelTradeByBuyer(${item.id})">ìˆ˜ë ¹ ì·¨ì†Œ</button>`;
                } else if (item.historyStatus === 'ì‹ ì²­ ì¤‘' && item.status === 'ì˜ˆì•½ì¤‘') {
                    // ìƒíƒœëŠ” 'ì˜ˆì•½ì¤‘'
                    displayStatus = 'ì˜ˆì•½ì¤‘';
                    statusClass = getStatusClass('ì˜ˆì•½ì¤‘');
                    // ì•¡ì…˜ ë²„íŠ¼ ìˆ˜ì •: 'ì‹ ì²­ ì·¨ì†Œ' -> 'ì˜ˆì•½ ì·¨ì†Œ'
                    actionButton = `<button class="action-btn cancel-trade-btn" onclick="cancelTradeByBuyer(${item.id})">ì˜ˆì•½ ì·¨ì†Œ</button>`;
                } else if (item.historyStatus === 'ì‹ ì²­ ê±°ì ˆ') {
                    displayStatus = 'ì‹ ì²­ ê±°ì ˆ (ê´€ë¦¬ì ì·¨ì†Œ)';
                    statusClass = getStatusClass('ì·¨ì†Œë¨');
                } else if (item.historyStatus === 'êµ¬ë§¤ì ì·¨ì†Œ') {
                    displayStatus = 'ì‹ ì²­/ì˜ˆì•½ ì·¨ì†Œ (êµ¬ë§¤ì ì·¨ì†Œ)';
                    statusClass = getStatusClass('ì·¨ì†Œë¨');
                } else {
                    return; 
                }
                
                const isNoImage = !isValidImageUrl(item.imageUrl);
                const displayImageUrl = isNoImage ? THUMBNAIL_PLACEHOLDER : item.imageUrl;
                
                let thumbnailHtml = '';
                if (isNoImage) {
                    thumbnailHtml = `<div class="item-thumbnail-wrapper">${NO_IMAGE_TEXT}</div>`;
                } else {
                    thumbnailHtml = `<div class="item-thumbnail-wrapper"><img src="${displayImageUrl}" alt="${item.name} ì´ë¯¸ì§€" class="item-thumbnail"></div>`;
                }

                const card = document.createElement('div');
                card.classList.add('item-card', 'history-card'); 
                
                card.innerHTML = `
                    ${thumbnailHtml}
                    <div class="item-content">
                        <div class="item-header">
                            <span class="item-name" title="${item.name}">${item.name}</span>
                            <span class="item-status ${statusClass}">${displayStatus}</span>
                        </div>
                        <div class="item-info">ë“±ë¡ì¼: ${item.registerDate || '-'}</div>
                        <div class="item-actions" style="margin-top: 5px;">
                            ${actionButton}
                            <span style="color:#777; font-size:0.8em; margin-left: 10px;">
                                ${item.description.substring(0, 50)}...
                            </span>
                        </div>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }

        // --- ê´€ë¦¬ì ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ (ì¹´ë“œ ë¦¬ìŠ¤íŠ¸) ---
        function renderAdminList() {
            if (!isAdmin) return;

            const listContainer = document.getElementById('adminListContainer');
            listContainer.innerHTML = '';
            
            const adminItems = items.filter(item => item.status === 'ìŠ¹ì¸ ëŒ€ê¸°' || item.status === 'ì˜ˆì•½ì¤‘');
            
            if (adminItems.length === 0) {
                 listContainer.innerHTML = '<p style="text-align: center; color: #555; padding: 20px; margin: 0;">í˜„ì¬ ê´€ë¦¬ ëŒ€ê¸° ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                 return;
            }

            adminItems.forEach(item => {
                let actions = '';
                let displayStatus = '';

                if (item.status === 'ìŠ¹ì¸ ëŒ€ê¸°') {
                    displayStatus = 'ë“±ë¡ ìŠ¹ì¸ ëŒ€ê¸°';
                    actions = `
                        <button class="admin-action-btn approve-btn" onclick="approveItem(${item.id})">ë“±ë¡ ìŠ¹ì¸</button>
                        <button class="admin-action-btn delete-btn item-delete-btn" data-item-id="${item.id}">ì‚­ì œ</button>
                    `;
                } else if (item.status === 'ì˜ˆì•½ì¤‘') {
                    if (item.historyStatus === 'ì‹ ì²­ ì¤‘') {
                        displayStatus = 'ë‚˜ëˆ” ì‹ ì²­ (1ë‹¨ê³„)'; 
                        actions = `
                            <button class="admin-action-btn approve-trade-btn" onclick="approveTrade(${item.id})">ë‚˜ëˆ” ì‹ ì²­ ìŠ¹ì¸</button> 
                            <button class="admin-action-btn cancel-trade-btn" onclick="cancelTradeByAdmin(${item.id})">ì‹ ì²­ ì·¨ì†Œ</button>
                        `;
                    } else if (item.historyStatus === 'ì˜ˆì•½ ìŠ¹ì¸') {
                        displayStatus = 'ë‚˜ëˆ” ì§„í–‰ (2ë‹¨ê³„)'; 
                        actions = `
                            <button class="admin-action-btn confirm-trade-btn" onclick="confirmTrade(${item.id})">ë‚˜ëˆ” ì™„ë£Œ</button> 
                            <button class="admin-action-btn cancel-trade-btn" onclick="cancelTradeByAdmin(${item.id})">ì˜ˆì•½ ì·¨ì†Œ</button>
                        `;
                    } else {
                        displayStatus = 'ì˜ˆì•½ì¤‘ (ìƒíƒœ í™•ì¸ í•„ìš”)';
                        actions = `
                            <button class="admin-action-btn cancel-trade-btn" onclick="cancelTradeByAdmin(${item.id})">ì˜ˆì•½ ì·¨ì†Œ</button>
                        `;
                    }
                }
                
                
                const isNoImage = !isValidImageUrl(item.imageUrl);
                const displayImageUrl = isNoImage ? THUMBNAIL_PLACEHOLDER : item.imageUrl;

                let thumbnailHtml = '';
                if (isNoImage) {
                    thumbnailHtml = `<div class="item-thumbnail-wrapper">${NO_IMAGE_TEXT}</div>`;
                } else {
                    thumbnailHtml = `<div class="item-thumbnail-wrapper"><img src="${displayImageUrl}" alt="${item.name} ì´ë¯¸ì§€" class="item-thumbnail"></div>`;
                }
                
                const card = document.createElement('div');
                card.classList.add('item-card', 'admin-card'); 
                card.style.cursor = 'default'; 

                // --- ì´ë¦„ê³¼ ìƒíƒœë¥¼ ë³„ë„ ì¤„ì— ë°°ì¹˜ (ì´ì „ ìˆ˜ì • ìœ ì§€) ---
                card.innerHTML = `
                    ${thumbnailHtml}
                    <div class="item-content">
                        <div class="item-header">
                            <span class="item-name" title="${item.name}">${item.name}</span>
                            <span class="item-status ${getStatusClass(item.status)}">${displayStatus}</span>
                        </div>
                        <div class="item-info">ë“±ë¡ì¼: ${item.registerDate || '-'}</div>
                        <div class="admin-info">ì‹ ì²­/ì˜ˆì•½ êµ¬ë§¤ì ID: ${item.buyerId || '-'}</div>
                        <div class="item-actions" style="margin-top: 10px;">
                            ${actions}
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(card);
                
                // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¬ì—°ê²°
                const deleteButton = card.querySelector(`.admin-action-btn.delete-btn[data-item-id="${item.id}"]`);
                if (deleteButton) {
                    deleteButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        deleteItem(item.id);
                    });
                }
            });
        }
        
        function updateListsAfterAction() {
            if (document.getElementById('adminListPage').style.display !== 'none') {
                 renderAdminList(); 
            }
            if (document.getElementById('buyerHistoryPage').style.display !== 'none') {
                renderBuyerHistory();
            }
            // ë©”ì¸ ëª©ë¡ ì—…ë°ì´íŠ¸
            renderItems(items.filter(item => item.status !== 'ìŠ¹ì¸ ëŒ€ê¸°')); 
        }
        
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const maxSizeInBytes = 2 * 1024 * 1024; // 2MB
                if (file.size > maxSizeInBytes) {
                     reject(new Error("File size exceeds 2MB limit."));
                     return;
                }
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function addItemAsync() {
            const itemNameInput = document.getElementById('itemName');
            const itemImageFileInput = document.getElementById('itemImageFile');
            const itemDescriptionInput = document.getElementById('itemDescription');
            
            const name = itemNameInput.value.trim();
            const description = itemDescriptionInput.value.trim(); 
            const file = itemImageFileInput.files[0];

            if (!name || !description) {
                alert('ì•„ì´í…œ ì´ë¦„ê³¼ ìƒì„¸ ì„¤ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let imageUrl = '';

            if (file) {
                try {
                    imageUrl = await convertFileToBase64(file);
                } catch (error) {
                    console.error('íŒŒì¼ ë³€í™˜ ì˜¤ë¥˜:', error);
                    alert('ì´ë¯¸ì§€ íŒŒì¼ ë³€í™˜ì— ì‹¤íŒ¨í–ˆê±°ë‚˜ íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (ìµœëŒ€ 2MB).');
                    return;
                }
            } else {
                 imageUrl = '';
            }

            const newId = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;

            items.push({ 
                id: newId, 
                name: name, 
                status: 'ìŠ¹ì¸ ëŒ€ê¸°', 
                description: description,
                imageUrl: imageUrl,
                buyerId: null,
                registerDate: getTodayDate(),
                category: 'ê¸°íƒ€', // ì¹´í…Œê³ ë¦¬ ì„ íƒ ê¸°ëŠ¥ ì‚­ì œë¡œ 'ê¸°íƒ€'ë¡œ ê³ ì •
                historyStatus: 'ì‹ ì²­ ì—†ìŒ'
            });
            
            alert(`ì•„ì´í…œ [${name}]ì´(ê°€) ë“±ë¡ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);

            toggleRegistrationForm(false);
        }

        function searchItems() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            let searchTargetItems = items.filter(item => item.status !== 'ìŠ¹ì¸ ëŒ€ê¸°');
            
            // ê²€ìƒ‰ì–´ í•„í„°ë§ ì ìš©
            const filteredItems = searchTargetItems.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.description.toLowerCase().includes(searchTerm)
            );

            renderItems(filteredItems);
        }

        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', searchItems);

        // --- ë”ë¯¸ ë¡œê·¸ì¸/ì•¡ì…˜ í•¨ìˆ˜ ---
        function toggleBuyerLogin() {
            if (isBuyerLoggedIn) {
                logoutBuyer();
            } else {
                loginBuyer();
            }
        }
        function loginBuyer() {
            const buyerIdInput = prompt("êµ¬ë§¤ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. (í…ŒìŠ¤íŠ¸ ID: buyer1, buyer2)");
            if (!buyerIdInput) return;
            const passwordInput = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (buyer1: 1111, buyer2: 2222)");
            if (!passwordInput) return;
            if (buyers[buyerIdInput] === passwordInput) {
                isBuyerLoggedIn = true;
                currentBuyerId = buyerIdInput;
                document.getElementById('buyerLoginBtn').innerText = 'êµ¬ë§¤ì ë¡œê·¸ì•„ì›ƒ';
                document.getElementById('currentBuyerName').innerText = currentBuyerId;
                document.getElementById('buyerStatus').style.display = 'block';
                document.getElementById('viewHistoryBtn').style.display = 'inline-block';
                updateListsAfterAction(); 
            } else { alert('ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); }
        }
        function logoutBuyer() {
            isBuyerLoggedIn = false;
            currentBuyerId = null;
            document.getElementById('buyerLoginBtn').innerText = 'êµ¬ë§¤ì ë¡œê·¸ì¸';
            document.getElementById('buyerStatus').style.display = 'none';
            document.getElementById('viewHistoryBtn').style.display = 'none';
            if (document.getElementById('buyerHistoryPage').style.display !== 'none') { toggleBuyerHistoryPage(false); }
            updateListsAfterAction(); 
        }
        function toggleAdminLogin() {
            if (isAdmin) {
                logoutAdmin();
            } else {
                loginAdmin();
            }
        }
        function loginAdmin() {
            const password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ë¹„ë°€ë²ˆí˜¸: 1234)");
            if (password === '1234') {
                isAdmin = true;
                document.getElementById('adminLoginBtn').innerText = 'ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ';
                updateListsAfterAction(); 
            } else if (password !== null) { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); }
        }
        function logoutAdmin() {
            isAdmin = false;
            document.getElementById('adminLoginBtn').innerText = 'ê´€ë¦¬ì ë¡œê·¸ì¸';
            document.getElementById('adminListBtn').style.display = 'none'; 
            if (document.getElementById('adminListPage').style.display !== 'none') { toggleAdminListPage(false); } else { updateListsAfterAction(); }
        }
        function applyForTrade(itemId) {
            if (!isBuyerLoggedIn || isAdmin) { alert('êµ¬ë§¤ìë¡œ ë¡œê·¸ì¸í•´ì•¼ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
            const item = items.find(i => i.id === itemId);
            if (item && item.status === 'íŒë§¤ ì¤‘') { 
                item.status = 'ì˜ˆì•½ì¤‘'; item.buyerId = currentBuyerId;
                item.historyStatus = 'ì‹ ì²­ ì¤‘'; item.historyBuyerId = currentBuyerId;
                alert(`${item.name}ì— ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì˜ 1ë‹¨ê³„ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);
                updateListsAfterAction(); 
            }
        }
        function approveTrade(itemId) {
            if (!isAdmin) return;
            const item = items.find(i => i.id === itemId);
            if (item && item.status === 'ì˜ˆì•½ì¤‘' && item.historyStatus === 'ì‹ ì²­ ì¤‘') { 
                item.historyStatus = 'ì˜ˆì•½ ìŠ¹ì¸'; 
                alert(`${item.name}ì˜ ë‚˜ëˆ” ì‹ ì²­ì´ 1ë‹¨ê³„ ìŠ¹ì¸ë˜ì–´ 'ê±°ë˜ ì˜ˆì•½ í™•ì •' ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹¤ë¬¼ ê±°ë˜ í›„ 'ë‚˜ëˆ” ì™„ë£Œ' í•„ìš”)`);
                updateListsAfterAction(); 
            }
        }
        function confirmTrade(itemId) {
             if (!isAdmin) return;
            const item = items.find(i => i.id === itemId);
            if (item && item.status === 'ì˜ˆì•½ì¤‘' && item.historyStatus === 'ì˜ˆì•½ ìŠ¹ì¸') { 
                item.status = 'ê±°ë˜ ì™„ë£Œ'; item.historyStatus = 'ê±°ë˜ í™•ì •';
                alert(`${item.name}ì˜ ê±°ë˜ê°€ ìµœì¢… í™•ì •ë˜ì–´ 'ë‚˜ëˆ” ì™„ë£Œ' ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`); 
                updateListsAfterAction(); 
            }
        }
        function approveItem(itemId) {
            if (!isAdmin) return;
            const item = items.find(i => i.id === itemId);
            if (item && item.status === 'ìŠ¹ì¸ ëŒ€ê¸°') {
                item.status = 'íŒë§¤ ì¤‘'; 
                alert(`${item.name} ì•„ì´í…œì´ ëª©ë¡ì— ë“±ë¡(ìŠ¹ì¸)ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                updateListsAfterAction(); 
            }
        }
        function deleteItem(itemId) {
            if (!isAdmin) return;
            if (confirm("ì •ë§ë¡œ ì´ ì•„ì´í…œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const index = items.findIndex(i => i.id === itemId);
                if (index > -1) {
                    items.splice(index, 1);
                    updateListsAfterAction(); 
                }
            }
        }
        function cancelTradeByAdmin(itemId) {
            if (!isAdmin) return;
            const item = items.find(i => i.id === itemId);
            if (item && item.status === 'ì˜ˆì•½ì¤‘') {
                if (confirm(`${item.name}ì— ëŒ€í•œ ë‚˜ëˆ” ì‹ ì²­/ì˜ˆì•½ì„ ì·¨ì†Œí•˜ê³  'ì‹ ì²­ ê°€ëŠ¥' ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    item.historyStatus = 'ì‹ ì²­ ê±°ì ˆ'; item.historyBuyerId = item.buyerId; 
                    item.status = 'íŒë§¤ ì¤‘'; item.buyerId = null; 
                    alert(`${item.name}ì˜ ë‚˜ëˆ” ì‹ ì²­/ì˜ˆì•½ì´ ì·¨ì†Œë˜ê³  'ì‹ ì²­ ê°€ëŠ¥' ìƒíƒœë¡œ ë³µê·€í–ˆìŠµë‹ˆë‹¤.`);
                    updateListsAfterAction(); 
                }
            }
        }
        function cancelTradeByBuyer(itemId) {
            if (!isBuyerLoggedIn) return;
            const item = items.find(i => i.id === itemId);
            if (item && item.status === 'ì˜ˆì•½ì¤‘' && item.buyerId === currentBuyerId) {
                // ì´ í•¨ìˆ˜ëŠ” 'ì‹ ì²­ ì·¨ì†Œ'ì™€ 'ì˜ˆì•½ ì·¨ì†Œ' ëª¨ë‘ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                const currentButtonText = (item.historyStatus === 'ì˜ˆì•½ ìŠ¹ì¸') ? 'ìˆ˜ë ¹ ì·¨ì†Œ' : 'ì˜ˆì•½ ì·¨ì†Œ';
                
                if (confirm(`${item.name}ì— ëŒ€í•œ ${currentButtonText}ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    item.status = 'íŒë§¤ ì¤‘'; item.historyStatus = 'êµ¬ë§¤ì ì·¨ì†Œ';
                    item.historyBuyerId = item.buyerId; item.buyerId = null; 
                    alert(`${item.name}ì˜ ${currentButtonText}ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    updateListsAfterAction();
                }
            }
        }
        function editItem(itemId) {
            if (!isAdmin) return;
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            
            const newName = prompt(`[${item.name}]ì˜ ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`, item.name);
            if (newName === null) return; 
            const newDescription = prompt(`[${item.name}]ì˜ ìƒˆ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:`, item.description);
            if (newDescription === null) return;

            // ì¹´í…Œê³ ë¦¬ ìˆ˜ì • ê¸°ëŠ¥ ì‚­ì œë¨
            
            const newImageUrl = prompt(`[${item.name}]ì˜ ìƒˆ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš” (ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ê³µë°±):`, item.imageUrl);
            
            item.name = newName.trim();
            item.description = newDescription.trim();
            // item.categoryëŠ” 'ê¸°íƒ€'ë¡œ ìœ ì§€ë˜ê±°ë‚˜ ë³€ê²½ë˜ì§€ ì•ŠìŒ

            if (newImageUrl !== null && newImageUrl.trim() !== "") { item.imageUrl = newImageUrl.trim(); }

            alert(`ì•„ì´í…œ [${item.id}]ì˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            updateListsAfterAction();
        }
    </script>
</body>
</html>